name: Auto Merge PRs for bvc-sa-gqe

on:
  pull_request_review:
    types: [submitted]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Get PR Review Details
        id: review_details
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          echo "Checking reviews for PR #$PR_NUMBER in repo $REPO"
          
          REVIEWS=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json reviews -q '.reviews')
          APPROVALS_COUNT=$(echo "$REVIEWS" | jq '[.[] | select(.state == "APPROVED")] | length')
          echo "Total approvals: $APPROVALS_COUNT"
          
          echo "approvals_count=$APPROVALS_COUNT" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GH_MERGE_TOKEN }}

      - name: Merge if 1 approvals
        if: steps.review_details.outputs.approvals_count == '1' && github.event.pull_request.user.login == 'viveksree1'
        run: gh pr merge --auto --squash "${{ github.event.pull_request.html_url }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN  }}
